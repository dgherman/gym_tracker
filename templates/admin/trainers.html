<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trainer Management - Admin Console</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">
  {% include "_nav.html" %}
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Main App</a></li>
            <li class="breadcrumb-item"><a href="/admin">Admin Console</a></li>
            <li class="breadcrumb-item active" aria-current="page">Trainer Management</li>
          </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1>Trainer Management</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTrainerModal">
            <i class="bi bi-plus-circle"></i> Add Trainer
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Area -->
    <div id="notification"></div>

    <!-- Trainers Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">All Trainers</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for trainer in trainers %}
                  <tr>
                    <td>{{ trainer.id }}</td>
                    <td>{{ trainer.name }}</td>
                    <td>
                      {% if trainer.is_active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                      {% endif %}
                    </td>
                    <td>{{ trainer.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editTrainer({{ trainer.id }}, '{{ trainer.name }}', {{ trainer.is_active|lower }})">
                        Edit
                      </button>
                      {% if trainer.is_active %}
                        <button class="btn btn-sm btn-outline-warning" onclick="deactivateTrainer({{ trainer.id }})">
                          Deactivate
                        </button>
                      {% else %}
                        <button class="btn btn-sm btn-outline-success" onclick="activateTrainer({{ trainer.id }})">
                          Activate
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Trainer Modal -->
  <div class="modal fade" id="addTrainerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Trainer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addTrainerForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="trainerName" class="form-label">Trainer Name</label>
              <input type="text" class="form-control" id="trainerName" required
                     placeholder="Enter trainer name" pattern=".*\S+.*"
                     title="Trainer name cannot be empty or contain only spaces">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Add Trainer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Trainer Modal -->
  <div class="modal fade" id="editTrainerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Trainer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editTrainerForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="editTrainerName" class="form-label">Trainer Name</label>
              <input type="text" class="form-control" id="editTrainerName" required
                     placeholder="Enter trainer name" pattern=".*\S+.*"
                     title="Trainer name cannot be empty or contain only spaces">
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editTrainerActive">
                <label class="form-check-label" for="editTrainerActive">
                  Active
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Trainer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentTrainerId = null;
    const addModal = new bootstrap.Modal(document.getElementById('addTrainerModal'));
    const editModal = new bootstrap.Modal(document.getElementById('editTrainerModal'));

    // Add trainer form submission
    document.getElementById('addTrainerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('trainerName').value;

      // Client-side validation
      if (!name || !name.trim()) {
        showNotification('Trainer name is required and cannot be empty', 'warning');
        return;
      }

      try {
        const response = await fetch('/api/trainers/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        if (response.ok) {
          showNotification('Trainer added successfully!', 'success');
          addModal.hide();
          document.getElementById('addTrainerForm').reset();
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error adding trainer', 'danger');
      }
    });

    // Edit trainer form submission
    document.getElementById('editTrainerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editTrainerName').value;
      const is_active = document.getElementById('editTrainerActive').checked;

      // Client-side validation
      if (!name || !name.trim()) {
        showNotification('Trainer name is required and cannot be empty', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/trainers/${currentTrainerId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, is_active })
        });

        if (response.ok) {
          showNotification('Trainer updated successfully!', 'success');
          editModal.hide();
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error updating trainer', 'danger');
      }
    });

    // Edit trainer function
    function editTrainer(id, name, isActive) {
      currentTrainerId = id;
      document.getElementById('editTrainerName').value = name;
      document.getElementById('editTrainerActive').checked = isActive;
      editModal.show();
    }

    // Quick activate/deactivate functions
    async function activateTrainer(id) {
      await updateTrainerStatus(id, true);
    }

    async function deactivateTrainer(id) {
      await updateTrainerStatus(id, false);
    }

    async function updateTrainerStatus(id, isActive) {
      try {
        const response = await fetch(`/api/trainers/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: isActive })
        });

        if (response.ok) {
          showNotification(`Trainer ${isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error updating trainer', 'danger');
      }
    }

    // Extract user-friendly error message from API response
    function extractErrorMessage(errorResponse) {
      // Handle Pydantic validation errors (422)
      if (errorResponse.detail && Array.isArray(errorResponse.detail)) {
        const firstError = errorResponse.detail[0];
        if (firstError && firstError.msg) {
          return firstError.msg;
        }
      }

      // Handle simple error messages
      if (typeof errorResponse.detail === 'string') {
        return errorResponse.detail;
      }

      // Handle case where detail is an object
      if (errorResponse.detail && typeof errorResponse.detail === 'object') {
        return JSON.stringify(errorResponse.detail);
      }

      // Fallback
      return 'An unexpected error occurred';
    }

    // Show notification function
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }
  </script>
</body>
</html>