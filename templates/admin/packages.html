<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Package Management - Admin Console</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">
  {% include "_nav.html" %}
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Main App</a></li>
            <li class="breadcrumb-item"><a href="/admin">Admin Console</a></li>
            <li class="breadcrumb-item active" aria-current="page">Package Management</li>
          </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1>Package Management</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPackageModal">
            <i class="bi bi-plus-circle"></i> Add Package
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Area -->
    <div id="notification"></div>

    <!-- Packages Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">All Packages</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Duration (min)</th>
                    <th>People</th>
                    <th>Sessions</th>
                    <th>Price/Session</th>
                    <th>Total Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for package in packages %}
                  <tr>
                    <td>{{ package.id }}</td>
                    <td>{{ package.name }}</td>
                    <td>{{ package.duration_minutes }}</td>
                    <td>{{ package.num_people }}</td>
                    <td>{{ package.total_sessions }}</td>
                    <td>${{ "%.2f"|format(package.price_per_session) }}</td>
                    <td>${{ "%.2f"|format(package.price_per_session * package.total_sessions) }}</td>
                    <td>
                      {% if package.is_active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick='editPackage({{ package.id }}, "{{ package.name }}", {{ package.duration_minutes }}, {{ package.num_people }}, {{ package.total_sessions }}, {{ package.price_per_session }}, {{ package.is_active|lower }})'>
                        Edit
                      </button>
                      {% if package.is_active %}
                        <button class="btn btn-sm btn-outline-warning" onclick="deactivatePackage({{ package.id }})">
                          Deactivate
                        </button>
                      {% else %}
                        <button class="btn btn-sm btn-outline-success" onclick="activatePackage({{ package.id }})">
                          Activate
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Package Modal -->
  <div class="modal fade" id="addPackageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Package</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addPackageForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="packageName" class="form-label">Package Name</label>
              <input type="text" class="form-control" id="packageName" required
                     placeholder="e.g., 30 min - 1 person">
            </div>
            <div class="mb-3">
              <label for="packageDuration" class="form-label">Duration (minutes)</label>
              <input type="number" class="form-control" id="packageDuration" required min="1"
                     placeholder="30, 45, or 60">
            </div>
            <div class="mb-3">
              <label for="packageNumPeople" class="form-label">Number of People</label>
              <input type="number" class="form-control" id="packageNumPeople" required min="1" max="10"
                     placeholder="1, 2, or 3">
            </div>
            <div class="mb-3">
              <label for="packageTotalSessions" class="form-label">Total Sessions</label>
              <input type="number" class="form-control" id="packageTotalSessions" required min="1"
                     placeholder="10">
            </div>
            <div class="mb-3">
              <label for="packagePrice" class="form-label">Price per Session ($)</label>
              <input type="number" class="form-control" id="packagePrice" required min="0" step="0.01"
                     placeholder="45.00">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Add Package</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Package Modal -->
  <div class="modal fade" id="editPackageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Package</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editPackageForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="editPackageName" class="form-label">Package Name</label>
              <input type="text" class="form-control" id="editPackageName" required>
            </div>
            <div class="mb-3">
              <label for="editPackageDuration" class="form-label">Duration (minutes)</label>
              <input type="number" class="form-control" id="editPackageDuration" required min="1">
            </div>
            <div class="mb-3">
              <label for="editPackageNumPeople" class="form-label">Number of People</label>
              <input type="number" class="form-control" id="editPackageNumPeople" required min="1" max="10">
            </div>
            <div class="mb-3">
              <label for="editPackageTotalSessions" class="form-label">Total Sessions</label>
              <input type="number" class="form-control" id="editPackageTotalSessions" required min="1">
            </div>
            <div class="mb-3">
              <label for="editPackagePrice" class="form-label">Price per Session ($)</label>
              <input type="number" class="form-control" id="editPackagePrice" required min="0" step="0.01">
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editPackageActive">
                <label class="form-check-label" for="editPackageActive">
                  Active
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Package</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPackageId = null;
    const addModal = new bootstrap.Modal(document.getElementById('addPackageModal'));
    const editModal = new bootstrap.Modal(document.getElementById('editPackageModal'));

    // Add package form submission
    document.getElementById('addPackageForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('packageName').value;
      const duration_minutes = parseInt(document.getElementById('packageDuration').value);
      const num_people = parseInt(document.getElementById('packageNumPeople').value);
      const total_sessions = parseInt(document.getElementById('packageTotalSessions').value);
      const price_per_session = parseFloat(document.getElementById('packagePrice').value);

      try {
        const response = await fetch('/api/packages/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            duration_minutes,
            num_people,
            total_sessions,
            price_per_session
          })
        });

        if (response.ok) {
          showNotification('Package added successfully!', 'success');
          addModal.hide();
          document.getElementById('addPackageForm').reset();
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error adding package', 'danger');
      }
    });

    // Edit package form submission
    document.getElementById('editPackageForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editPackageName').value;
      const duration_minutes = parseInt(document.getElementById('editPackageDuration').value);
      const num_people = parseInt(document.getElementById('editPackageNumPeople').value);
      const total_sessions = parseInt(document.getElementById('editPackageTotalSessions').value);
      const price_per_session = parseFloat(document.getElementById('editPackagePrice').value);
      const is_active = document.getElementById('editPackageActive').checked;

      try {
        const response = await fetch(`/api/packages/${currentPackageId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            duration_minutes,
            num_people,
            total_sessions,
            price_per_session,
            is_active
          })
        });

        if (response.ok) {
          showNotification('Package updated successfully!', 'success');
          editModal.hide();
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error updating package', 'danger');
      }
    });

    // Edit package function
    function editPackage(id, name, durationMinutes, numPeople, totalSessions, pricePerSession, isActive) {
      currentPackageId = id;
      document.getElementById('editPackageName').value = name;
      document.getElementById('editPackageDuration').value = durationMinutes;
      document.getElementById('editPackageNumPeople').value = numPeople;
      document.getElementById('editPackageTotalSessions').value = totalSessions;
      document.getElementById('editPackagePrice').value = pricePerSession;
      document.getElementById('editPackageActive').checked = isActive;
      editModal.show();
    }

    // Quick activate/deactivate functions
    async function activatePackage(id) {
      await updatePackageStatus(id, true);
    }

    async function deactivatePackage(id) {
      await updatePackageStatus(id, false);
    }

    async function updatePackageStatus(id, isActive) {
      try {
        const response = await fetch(`/api/packages/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: isActive })
        });

        if (response.ok) {
          showNotification(`Package ${isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          const error = await response.json();
          const errorMessage = extractErrorMessage(error);
          showNotification(errorMessage, 'danger');
        }
      } catch (err) {
        showNotification('Error updating package', 'danger');
      }
    }

    // Extract user-friendly error message from API response
    function extractErrorMessage(errorResponse) {
      // Handle Pydantic validation errors (422)
      if (errorResponse.detail && Array.isArray(errorResponse.detail)) {
        const firstError = errorResponse.detail[0];
        if (firstError && firstError.msg) {
          return firstError.msg;
        }
      }

      // Handle simple error messages
      if (typeof errorResponse.detail === 'string') {
        return errorResponse.detail;
      }

      // Handle case where detail is an object
      if (errorResponse.detail && typeof errorResponse.detail === 'object') {
        return JSON.stringify(errorResponse.detail);
      }

      // Fallback
      return 'An unexpected error occurred';
    }

    // Show notification function
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }
  </script>
</body>
</html>
