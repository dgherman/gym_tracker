<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gym Session Tracker</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">
  {% include "_nav.html" %}
  <div class="container py-4">
    <h1 class="mb-4">Gym Session Tracker</h1>

    <!-- Summary Panel -->
    <div id="summary" class="mb-4">Loading summary...</div>

    <!-- Action Buttons -->
    <div class="mb-4">
      <div class="d-flex mb-2">
        <button id="logSessionBtn" class="btn btn-success me-2">Log Session</button>
        <button id="buyPackageBtn" class="btn btn-warning">Purchase Package</button>
      </div>
      <div class="mb-2">
        <a href="/history" class="btn btn-info">View History</a>
        <a href="/reports" class="btn btn-info ms-2">View Reports</a>
      </div>
    </div>

    <!-- Notification Area -->
    <div id="notification"></div>
  </div>

  <!-- Log Session Modal -->
  <div class="modal fade" id="logSessionModal" tabindex="-1" aria-labelledby="logSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logSessionModalLabel">Log Session</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="sessionPackageSelect" class="form-label">Select Package</label>
            <select id="sessionPackageSelect" class="form-select" required>
              <option value="">-- Select a package --</option>
              <!-- Options will be populated dynamically -->
            </select>
            <div class="form-text">Only packages with available sessions are shown</div>
          </div>
          <div class="mb-3">
            <label for="modalTrainerSelect" class="form-label">Select Trainer</label>
            <select id="modalTrainerSelect" class="form-select" required>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div class="mb-3 d-none" id="sessionPartnerGroup">
            <label for="sessionPartnerEmail" class="form-label">Partner Email</label>
            <input type="email" id="sessionPartnerEmail" class="form-control" placeholder="partner@example.com">
            <div class="form-text">Optional. If left empty, the partner from the purchased package will be used.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmLogSession" class="btn btn-success">Log Session</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Purchase Package Modal -->
  <div class="modal fade" id="purchasePackageModal" tabindex="-1" aria-labelledby="purchasePackageLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="purchasePackageLabel">Purchase Package</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="purchasePackageSelect" class="form-label">Select Package</label>
            <select id="purchasePackageSelect" class="form-select" required>
              <option value="">-- Select a package --</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div id="packageDetails" class="alert alert-info d-none">
            <strong>Package Details:</strong>
            <div id="packageDetailsContent"></div>
          </div>
          <div class="mb-3 d-none" id="purchasePartnerGroup">
            <label for="purchasePartnerEmail" class="form-label">Partner Email</label>
            <input type="email" id="purchasePartnerEmail" class="form-control" placeholder="partner@example.com">
            <div class="form-text">Email of your training partner for this 2-person package</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmPurchase" class="btn btn-warning">Purchase Package</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allPackages = [];
    let selectedPackageForPurchase = null;
    const logSessionModal = new bootstrap.Modal(document.getElementById('logSessionModal'));
    const purchasePackageModal = new bootstrap.Modal(document.getElementById('purchasePackageModal'));

    // Load packages from API
    async function loadPackages() {
      try {
        const res = await fetch('/api/packages/');
        allPackages = await res.json();
        populatePurchasePackages();
      } catch (err) {
        console.error("loadPackages error:", err);
      }
    }

    // Load trainers from API
    async function loadTrainers() {
      try {
        const res = await fetch('/api/trainers/');
        const trainers = await res.json();
        const select = document.getElementById('modalTrainerSelect');
        select.innerHTML = trainers
          .map(trainer => `<option value="${trainer.name}">${trainer.name}</option>`)
          .join('');
      } catch (err) {
        console.error("loadTrainers error:", err);
        document.getElementById('modalTrainerSelect').innerHTML =
          '<option disabled>Error loading trainers</option>';
      }
    }

    // Populate session package dropdown (only packages with remaining sessions)
    let latestSummary = [];
    async function populateSessionPackages() {
      try {
        const res = await fetch('/summary/');
        latestSummary = await res.json();

        const select = document.getElementById('sessionPackageSelect');
        const options = ['<option value="">-- Select a package --</option>'];

        for (const pkg of allPackages) {
          // Find matching summary entry by duration AND num_people
          const entry = latestSummary.find(s =>
            s.duration === pkg.duration_minutes && s.num_people === pkg.num_people
          );
          const remaining = entry ? entry.remaining : 0;
          if (remaining > 0) {
            options.push(`<option value="${pkg.duration_minutes}" data-num-people="${pkg.num_people}">
              ${pkg.name} (${remaining} sessions remaining)
            </option>`);
          }
        }

        select.innerHTML = options.join('');
      } catch (err) {
        console.error("populateSessionPackages error:", err);
      }
    }

    // Populate purchase package dropdown (all active packages)
    function populatePurchasePackages() {
      const select = document.getElementById('purchasePackageSelect');
      const options = ['<option value="">-- Select a package --</option>'];

      for (const pkg of allPackages) {
        const totalCost = (pkg.price_per_session * pkg.total_sessions).toFixed(2);
        options.push(`<option value="${pkg.id}">
          ${pkg.name} - ${pkg.total_sessions} sessions for $${totalCost}
        </option>`);
      }

      select.innerHTML = options.join('');
    }

    // Show package details when selected for purchase
    document.getElementById('purchasePackageSelect').addEventListener('change', (e) => {
      const packageId = parseInt(e.target.value);
      if (packageId) {
        const pkg = allPackages.find(p => p.id === packageId);
        if (pkg) {
          selectedPackageForPurchase = pkg;
          const totalCost = (pkg.price_per_session * pkg.total_sessions).toFixed(2);
          document.getElementById('packageDetailsContent').innerHTML = `
            <ul class="mb-0">
              <li><strong>Duration:</strong> ${pkg.duration_minutes} minutes</li>
              <li><strong>Number of People:</strong> ${pkg.num_people}</li>
              <li><strong>Total Sessions:</strong> ${pkg.total_sessions}</li>
              <li><strong>Price per Session:</strong> $${pkg.price_per_session.toFixed(2)}</li>
              <li><strong>Total Cost:</strong> $${totalCost}</li>
            </ul>
          `;
          document.getElementById('packageDetails').classList.remove('d-none');
          // Show partner email field for 2+ person packages
          const partnerGroup = document.getElementById('purchasePartnerGroup');
          if (pkg.num_people >= 2) {
            partnerGroup.classList.remove('d-none');
          } else {
            partnerGroup.classList.add('d-none');
            document.getElementById('purchasePartnerEmail').value = '';
          }
        }
      } else {
        selectedPackageForPurchase = null;
        document.getElementById('packageDetails').classList.add('d-none');
        document.getElementById('purchasePartnerGroup').classList.add('d-none');
      }
    });

    // Render the summary alerts
    async function refreshSummary() {
      try {
        await populateSessionPackages();
        const data = latestSummary;
        document.getElementById('summary').innerHTML = data
          .map(entry => {
            const peopleLabel = entry.num_people > 1 ? ` (${entry.num_people} persons)` : '';
            return `
              <div class="alert ${entry.remaining === 0 ? 'alert-danger' : 'alert-info'}">
                Duration ${entry.duration}-min${peopleLabel}: ${entry.remaining} left
              </div>
            `;
          }).join('');
      } catch (err) {
        console.error("refreshSummary error:", err);
        document.getElementById('summary').textContent = 'Error loading remaining sessions';
      }
    }

    // Show/hide partner field based on selected session package
    document.getElementById('sessionPackageSelect').addEventListener('change', (e) => {
      const selected = e.target.selectedOptions[0];
      const numPeople = parseInt(selected?.dataset.numPeople || '1');
      const partnerGroup = document.getElementById('sessionPartnerGroup');
      if (numPeople >= 2) {
        partnerGroup.classList.remove('d-none');
      } else {
        partnerGroup.classList.add('d-none');
        document.getElementById('sessionPartnerEmail').value = '';
      }
    });

    // Show log session modal
    document.getElementById('logSessionBtn').addEventListener('click', () => {
      logSessionModal.show();
    });

    // Show purchase package modal
    document.getElementById('buyPackageBtn').addEventListener('click', () => {
      selectedPackageForPurchase = null;
      document.getElementById('packageDetails').classList.add('d-none');
      document.getElementById('purchasePartnerGroup').classList.add('d-none');
      document.getElementById('purchasePartnerEmail').value = '';
      purchasePackageModal.show();
    });

    // Confirm and log session
    document.getElementById('confirmLogSession').addEventListener('click', async () => {
      const select = document.getElementById('sessionPackageSelect');
      const durationMinutes = parseInt(select.value);
      const trainer = document.getElementById('modalTrainerSelect').value;
      const partnerEmail = document.getElementById('sessionPartnerEmail').value.trim();
      const numPeople = parseInt(select.selectedOptions[0]?.dataset.numPeople || '1');

      if (!durationMinutes || !trainer) {
        alert('Please select both a package and a trainer');
        return;
      }

      logSessionModal.hide();

      const payload = { duration_minutes: durationMinutes, trainer, num_people: numPeople };
      if (partnerEmail) {
        payload.partner_email = partnerEmail;
      }

      const res = await fetch('/sessions/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const notif = document.getElementById('notification');
      if (res.ok) {
        const s = await res.json();
        notif.innerHTML = `<div class="alert alert-success">
          Logged ${s.duration_minutes}-min session with ${s.trainer}.${s.purchase_exhausted ? ' Purchase exhausted!' : ''}
        </div>`;
      } else {
        const e = await res.json();
        notif.innerHTML = `<div class="alert alert-warning">${e.detail}</div>`;
      }

      refreshSummary();
    });

    // Confirm and purchase package
    document.getElementById('confirmPurchase').addEventListener('click', async () => {
      if (!selectedPackageForPurchase) {
        alert('Please select a package');
        return;
      }

      const partnerEmail = document.getElementById('purchasePartnerEmail').value.trim();

      // Require partner email for 2-person packages
      if (selectedPackageForPurchase.num_people >= 2 && !partnerEmail) {
        alert('Please enter your partner\'s email for this 2-person package');
        return;
      }

      purchasePackageModal.hide();

      const totalCost = selectedPackageForPurchase.price_per_session * selectedPackageForPurchase.total_sessions;

      const payload = {
        duration_minutes: selectedPackageForPurchase.duration_minutes,
        cost: totalCost,
        num_people: selectedPackageForPurchase.num_people
      };
      if (partnerEmail) {
        payload.partner_email = partnerEmail;
      }

      const res = await fetch('/purchases/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const notif = document.getElementById('notification');
      if (res.ok) {
        const p = await res.json();
        notif.innerHTML = `<div class="alert alert-success">
          Purchased ${selectedPackageForPurchase.name} (${p.total_sessions} sessions) for $${p.cost.toFixed(2)}.
        </div>`;
      } else {
        const e = await res.json();
        notif.innerHTML = `<div class="alert alert-danger">Error purchasing package: ${e.detail}</div>`;
      }

      refreshSummary();
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPackages();
      await loadTrainers();
      await refreshSummary();
    });
  </script>
</body>
</html>
